#!/bin/bash
# ==============================================================================
# Blue/Green ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ for Etch Project
# ==============================================================================
#
# ì‚¬ìš©ë²•:
# ./deploy.sh business-server
# ./deploy.sh frontend
#
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Jenkinsfileì— ì˜í•´ í˜¸ì¶œë˜ë©°, ì£¼ì–´ì§„ ì„œë¹„ìŠ¤($1)ì— ëŒ€í•´
# ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìžë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
#

# --- ìŠ¤í¬ë¦½íŠ¸ ê¸°ë³¸ ì„¤ì • ---
# 1. ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
set -e
# 2. ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì´ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ê²½ë¡œ ë¬¸ì œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
cd "$(dirname "$0")"

# --- 1. ë°°í¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ í™•ì¸ ë° ë³€ìˆ˜ ì„¤ì • ---
# Jenkinsë¡œë¶€í„° ì²« ë²ˆì§¸ ì¸ìž($1)ë¡œ ë°°í¬í•  ì„œë¹„ìŠ¤ ì´ë¦„ì„ ë°›ìŠµë‹ˆë‹¤.
SERVICE_NAME=$1

# ì¸ìžê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ë²•ì„ ì•ˆë‚´í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
if [ -z "$SERVICE_NAME" ]; then
    echo "!!! [ERROR] ë°°í¬í•  ì„œë¹„ìŠ¤ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”. (ì˜ˆ: ./deploy.sh business-server)"
    exit 1
fi

# ë°°í¬í•  ì„œë¹„ìŠ¤ì— ë”°ë¼ ì‚¬ìš©í•  ì„¤ì • íŒŒì¼, ë³€ìˆ˜ ì´ë¦„ ë“±ì„ ë™ì ìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
if [ "$SERVICE_NAME" == "business-server" ]; then
    NGINX_CONF_FILE="./nginx/conf.d/blue-green-business-server.inc"
    UPSTREAM_VAR_NAME="\$target_business_server_upstream"
    UPSTREAM_GROUP_NAME="business-servers" # Nginx upstream ì´ë¦„
    HEALTH_CHECK_ENABLED=true
elif [ "$SERVICE_NAME" == "frontend" ]; then
    NGINX_CONF_FILE="./nginx/conf.d/blue-green-frontend.inc"
    UPSTREAM_VAR_NAME="\$target_frontend_upstream"
    UPSTREAM_GROUP_NAME="frontend-server" # Nginx upstream ì´ë¦„
    HEALTH_CHECK_ENABLED=false # FrontendëŠ” ë³„ë„ì˜ í—¬ìŠ¤ì²´í¬ë¥¼ ìƒëžµí•©ë‹ˆë‹¤.
else
    echo "!!! [ERROR] ìž˜ëª»ëœ ì„œë¹„ìŠ¤ ì´ë¦„ìž…ë‹ˆë‹¤: ${SERVICE_NAME}. 'business-server' ë˜ëŠ” 'frontend'ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    exit 1
fi

echo "========================================"
echo " Starting Blue/Green Deployment for [${SERVICE_NAME}]"
echo "========================================"

# --- 2. ìµœì‹  Docker ì´ë¯¸ì§€ ë°›ê¸° ---
echo ">>> [Step 1/7] Pulling latest image for ${SERVICE_NAME}..."
# blueì™€ greenì€ ë™ì¼í•œ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ì´ë¦„ì´ ê³ ì •ëœ -blue ì„œë¹„ìŠ¤ë¥¼ pull í•©ë‹ˆë‹¤.
docker-compose pull ${SERVICE_NAME}-blue

# --- 3. í˜„ìž¬ ìš´ì˜(LIVE) ê·¸ë£¹ê³¼ ë°°í¬í• (IDLE) ê·¸ë£¹ ê²°ì • ---
echo ">>> [Step 2/7] Checking current LIVE group..."
# Nginx ì„¤ì • íŒŒì¼ì„ ì½ì–´ í˜„ìž¬ íŠ¸ëž˜í”½ì´ ì–´ëŠ ê·¸ë£¹ìœ¼ë¡œ í–¥í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
CURRENT_UPSTREAM_LINE=$(grep "${UPSTREAM_VAR_NAME}" ${NGINX_CONF_FILE})

if [[ "$CURRENT_UPSTREAM_LINE" == *"blue"* ]]; then
    LIVE_GROUP="blue"
    IDLE_GROUP="green"
else
    LIVE_GROUP="green"
    IDLE_GROUP="blue"
fi

# ë°°í¬í•  ëŒ€ìƒ ì»¨í…Œì´ë„ˆì˜ ì „ì²´ ì´ë¦„ì„ ë³€ìˆ˜ì— ì €ìž¥í•©ë‹ˆë‹¤. (ì˜ˆ: business-server-green)
IDLE_CONTAINER="${SERVICE_NAME}-${IDLE_GROUP}"
echo "==> Current LIVE group: ${SERVICE_NAME}-${LIVE_GROUP}"
echo "==> Deploying to IDLE group: ${IDLE_CONTAINER}"

# --- 4. ìƒˆ ë²„ì „ì˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (IDLE ê·¸ë£¹) ---
echo ">>> [Step 3/7] Starting new container for IDLE group..."
# --no-deps: ì˜ì¡´ ê´€ê³„ì— ìžˆëŠ” ë‹¤ë¥¸ ì„œë¹„ìŠ¤ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³ , ì§€ì •ëœ ì„œë¹„ìŠ¤ë§Œ ìž¬ì‹œìž‘í•©ë‹ˆë‹¤.
docker-compose up -d --force-recreate --no-deps ${IDLE_CONTAINER}

# --- 5. í—¬ìŠ¤ ì²´í¬ ---
echo ">>> [Step 4/7] Health check for new container..."
if [ "$HEALTH_CHECK_ENABLED" = true ]; then
    # business-serverì˜ í¬íŠ¸ëŠ” ê·¸ë£¹ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤. (blue: 8081, green: 8085)
    if [ "$IDLE_GROUP" == "blue" ]; then
        IDLE_PORT="8081"
    else
        IDLE_PORT="8085" # docker-compose.ymlì— ëª…ì‹œëœ ê·¸ë¦° ì„œë²„ í¬íŠ¸
    fi

    echo "==> Waiting for health check on http://localhost:${IDLE_PORT}/actuator/health..."
    # 12ë²ˆ ì‹œë„ (5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì´ 60ì´ˆ ëŒ€ê¸°)
    for i in {1..12}; do
        echo "i: $i"
        RESPONSE=$(curl -s http://localhost:${IDLE_PORT}/actuator/health || true)
        echo "Response: ${RESPONSE}"
        # jq ì—†ì´ status ê°’ ì¶”ì¶œ (ìµœìƒìœ„ statusë§Œ ì¶”ì¶œ)
        STATUS=$(echo "$RESPONSE" | jq -r .status)

        if [ "$STATUS" == "UP" ]; then
            echo "Health check PASSED! Server is UP. âœ…"
            break
        fi
        echo "Health check waiting... (Status: ${STATUS:-'No response'}, Retry: $i/12)"
        sleep 5
    done

    # 60ì´ˆê°€ ì§€ë‚˜ë„ í—¬ìŠ¤ ì²´í¬ì— ì‹¤íŒ¨í•˜ë©´, ë°°í¬ë¥¼ ì¤‘ë‹¨í•˜ê³  ìƒˆë¡œ ë„ìš´ ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤ (ë¡¤ë°±).
    if [ "$STATUS" != "UP" ]; then
        echo "!!! [FATAL] Deployment FAILED: New server is not healthy."
        echo "!!! Last Health Check Response: $RESPONSE"
        echo ">>> Rolling back... Stopping the new container."
        docker-compose stop ${IDLE_CONTAINER}
        exit 1 # ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤íŒ¨ ìƒíƒœë¡œ ì¢…ë£Œí•˜ì—¬ Jenkinsì— ì•Œë¦½ë‹ˆë‹¤.
    fi
else
    # FrontendëŠ” ë³„ë„ì˜ í—¬ìŠ¤ì²´í¬ APIê°€ ì—†ìœ¼ë¯€ë¡œ, ì‹œìž‘ë  ë•Œê¹Œì§€ 15ì´ˆê°„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    echo "==> Waiting 15 seconds for frontend container to start..."
    sleep 15
    echo "Frontend container is assumed to be up."
fi

# --- 6. Nginx íŠ¸ëž˜í”½ ì „í™˜ ---
echo ">>> [Step 5/7] Switching Nginx traffic to ${IDLE_GROUP} group..."

echo "==> Ensuring all Blue/Green containers are running for Nginx reload..."
docker-compose up -d --no-deps business-server-blue business-server-green frontend-blue frontend-green

# Nginx ì„¤ì • íŒŒì¼ì˜ ë‚´ìš©ì„ ìƒˆë¡œìš´ upstream ê·¸ë£¹ì„ ë°”ë¼ë³´ë„ë¡ ë®ì–´ì”ë‹ˆë‹¤.
if [ "$SERVICE_NAME" == "business-server" ]; then
    echo "set ${UPSTREAM_VAR_NAME} http://${IDLE_GROUP}-${UPSTREAM_GROUP_NAME};" > ${NGINX_CONF_FILE}
else # frontend
    echo "set ${UPSTREAM_VAR_NAME} http://${IDLE_GROUP}-${UPSTREAM_GROUP_NAME};" > ${NGINX_CONF_FILE} # upstream ì´ë¦„ ê·œì¹™ì— ë§žì¶¤
fi

# Nginx ì„¤ì •ì„ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ ì¦‰ì‹œ ë¦¬ë¡œë“œí•©ë‹ˆë‹¤.
docker-compose exec nginx nginx -s reload
echo ">>> [Step 6/7] Traffic switched successfully! ðŸš€"

# --- 7. êµ¬ë²„ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ---
LIVE_CONTAINER="${SERVICE_NAME}-${LIVE_GROUP}"
echo ">>> [Step 7/7] Stopping old version: ${LIVE_CONTAINER}"
docker-compose stop ${LIVE_CONTAINER}

# --- 8. ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì˜ ìœ íœ´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ---
echo ">>> [Step extra] Cleaning up idle container of the other service..."
if [ "$SERVICE_NAME" == "business-server" ]; then
    # business-serverë¥¼ ë°°í¬í–ˆìœ¼ë‹ˆ, frontendì˜ ìœ íœ´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì•„ì„œ ì¤‘ì§€
    CURRENT_FRONTEND_UPSTREAM_LINE=$(grep "\$target_frontend_upstream" ./nginx/conf.d/blue-green-frontend.inc)
    if [[ "$CURRENT_FRONTEND_UPSTREAM_LINE" == *"blue"* ]]; then
        echo "==> Frontend LIVE is blue, stopping idle container: frontend-green"
        docker-compose stop frontend-green
    else
        echo "==> Frontend LIVE is green, stopping idle container: frontend-blue"
        docker-compose stop frontend-blue
    fi
elif [ "$SERVICE_NAME" == "frontend" ]; then
    # frontendë¥¼ ë°°í¬í–ˆìœ¼ë‹ˆ, business-serverì˜ ìœ íœ´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì•„ì„œ ì¤‘ì§€
    CURRENT_BUSINESS_UPSTREAM_LINE=$(grep "\$target_business_server_upstream" ./nginx/conf.d/blue-green-business-server.inc)
    if [[ "$CURRENT_BUSINESS_UPSTREAM_LINE" == *"blue"* ]]; then
        echo "==> Business-server LIVE is blue, stopping idle container: business-server-green"
        docker-compose stop business-server-green
    else
        echo "==> Business-server LIVE is green, stopping idle container: business-server-blue"
        docker-compose stop business-server-blue
    fi
fi

echo "========================================"
echo " Blue/Green Deployment for [${SERVICE_NAME}] Completed!"
echo " All idle containers are cleaned up. âœ…"
echo "========================================"
